<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Detalhes do Pedido - Magic Travel">
  <title>Detalhes do Pedido - Magic Travel</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 20px;
    }

    .order-details {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .order-details h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 25px;
      color: #0d112d;
      text-align: center;
    }

    .order-details h3 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #4a4a4a;
    }

    .order-details p {
      font-size: 18px;
      margin-bottom: 20px;
      color: #666;
      text-align: center;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 30px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      color: #fff;
      background-color: #3b7ddd;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s, transform 0.3s;
    }

    .back-button:hover {
      background-color: #565e64;
      transform: scale(1.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      border-radius: 12px;
      overflow: hidden;
    }

    table th, table td {
      padding: 16px 18px;
      text-align: left;
      border-bottom: 1px solid #ebebf0;
    }

    table th {
      font-weight: 600;
      color: #ffffff;
      background-color: #3b7ddd;
    }

    table td {
      color: #333;
    }

    table tr:nth-child(even) {
      background-color: #f7f7fb;
    }

    .section {
      margin-bottom: 40px;
    }

    .add-row-button {
      background-color: #1cbb8c;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
    }

    .add-row-button:hover {
      background-color: #17a37a;
      transform: scale(1.05);
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 4px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .planilha-pedido {
      display: flex;
      flex-direction: column;
      margin-bottom: 40px;
    }

    .planilha-tabela {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
    }

    .planilha-tabela thead th {
      text-align: center;
      background-color: #4a90e2;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid #d9d9d9;
      padding: 10px;
    }

    .planilha-tabela th, .planilha-tabela td {
      padding: 14px 16px;
      text-align: center;
      border: 1px solid #d9d9d9;
      font-weight: 500;
    }

    .planilha-tabela td {
      color: #333;
      background-color: #f9f9f9;
    }

    .planilha-tabela tr:nth-child(even) {
      background-color: #eef4fb;
    }

    .planilha-tabela input, .planilha-tabela select {
      width: 100%;
      padding: 8px;
      margin: 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .planilha-tabela thead th:first-child {
      border-top-left-radius: 12px;
    }

    .planilha-tabela thead th:last-child {
      border-top-right-radius: 12px;
    }

    .planilha-tabela tbody tr:last-child td:first-child {
      border-bottom-left-radius: 12px;
    }

    .planilha-tabela tbody tr:last-child td:last-child {
      border-bottom-right-radius: 12px;
    }

    .dropdown-status {
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      color: #fff;
      transition: background-color 0.3s ease;
    }

    .status-primary { background-color: #007bff; }
    .status-info { background-color: #17a2b8; }
    .status-warning { background-color: #ffc107; color: #212529; }
    .status-danger { background-color: #dc3545; }
    .status-secondary { background-color: #6c757d; }
    .status-success { background-color: #28a745; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar-container">
    <div class="sidebar-loading">Carregando...</div>
  </div>

  <!-- Conteúdo principal -->
  <div class="order-details">
    <a href="pages-orders.html" class="back-button">Voltar para Página de Pedidos</a>

    <h1>Detalhes do Pedido</h1>
    <p>ID do Pedido: <span id="pedido-id">Carregando...</span></p>

    <!-- Informações do Pedido -->
    <div class="section">
      <h3>Informações do Pedido</h3>
      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th>Destino</th>
            <th>Item/Categoria</th>
            <th>Data Venda</th>
          </tr>
        </thead>
        <tbody id="order-info"></tbody>
      </table>
    </div>

    <!-- Informações do Cliente -->
    <div class="section">
      <h3>Informações do Cliente</h3>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>CPF</th>
            <th>Data de Nascimento</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="customer-info"></tbody>
      </table>
    </div>

    <!-- Informações Financeiras -->
    <div class="section">
      <h3>Informações Financeiras</h3>
      <table>
        <thead>
          <tr>
            <th>Gateway</th>
            <th>Data Pgto</th>
            <th>Recebido</th>
            <th>Valor Repassado</th>
            <th>Data Repasse</th>
            <th>Cambio do Dia</th>
          </tr>
        </thead>
        <tbody id="financial-info"></tbody>
      </table>
      <table>
        <thead>
          <tr>
            <th>Valor Comissão</th>
            <th>Meio Pgto</th>
            <th>Bandeira Cartão</th>
            <th>Parcelas</th>
            <th>Valor Venda</th>
            <th>Custo</th>
            <th>Fornecedor</th>
          </tr>
        </thead>
        <tbody id="financial-info-2"></tbody>
      </table>
    </div>

    <!-- Informações Comerciais -->
    <div class="section">
      <h3>Informações Comerciais</h3>
      <table>
        <thead>
          <tr>
            <th>Origem do Cliente</th>
            <th>Cliente de (30%)</th>
            <th>Efetivado por (70%)</th>
            <th>Comissão Agente</th>
          </tr>
        </thead>
        <tbody id="commercial-info"></tbody>
      </table>
    </div>

    <!-- Informações Adicionais -->
    <div class="section">
      <h3>Informações Adicionais</h3>
      <table>
        <thead>
          <tr>
            <th>Observações Operacionais</th>
            <th>Observações Financeiras</th>
          </tr>
        </thead>
        <tbody id="additional-info"></tbody>
      </table>
    </div>

    <!-- Planilha do Pedido -->
    <div class="section planilha-pedido">
      <h3>Planilha do Pedido</h3>
      <table class="planilha-tabela">
        <thead>
          <tr>
            <th>Dolar Câmbio</th>
            <th>Dolar Magic</th>
          </tr>
        </thead>
        <tbody id="spreadsheet-info-1"></tbody>
      </table>
      <table class="planilha-tabela">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Idade</th>
            <th>Net U$</th>
            <th>Lobista</th>
            <th>Número</th>
            <th>Total U$</th>
            <th>Net R$</th>
            <th>Margem</th>
            <th>Pix</th>
            <th>Taxa</th>
            <th>10x</th>
          </tr>
        </thead>
        <tbody id="spreadsheet-info-2"></tbody>
      </table>
      <button id="add-row-button" class="add-row-button">Adicionar Linha</button>
    </div>

    <!-- Emissão -->
    <div class="section">
      <h3>Emissão</h3>
      <table>
        <thead>
          <tr>
            <th>Invoice</th>
            <th>Nome dos Passageiros</th>
            <th>Itens</th>
            <th>Identificador</th>
            <th>Data de Pagamento</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="emission-info"></tbody>
      </table>
    </div>
  </div>

  <script>
    // Função para capturar o ID do pedido na URL
    function getPedidoId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('pedido') || 'Não informado';
    }

    // Função para formatar datas
    function formatDate(date) {
      return date ? new Date(date).toLocaleDateString('pt-BR') : 'N/A';
    }

    // Função para carregar a sidebar
    async function loadSidebar() {
      try {
        const response = await fetch('sidebar.html');
        if (!response.ok) throw new Error('Erro ao carregar a sidebar.');

        const sidebarContent = await response.text();
        document.getElementById('sidebar-container').innerHTML = sidebarContent;
      } catch (error) {
        console.error('Erro ao carregar a sidebar:', error);
        document.getElementById('sidebar-container').innerHTML = '<p>Erro ao carregar a sidebar.</p>';
      }
    }

    // Função para carregar os detalhes do pedido
    async function loadOrderDetails() {
      const pedidoId = getPedidoId();
      if (pedidoId === 'Não informado') {
        alert('ID do pedido não informado!');
        return;
      }

      try {
        const apiUrl = `https://www.magictraveltur.com/api_pedidos.php?pedido=${pedidoId}`;
        const planilhasApiUrl = `https://www.magictraveltur.com/api_planilhas.php?pedido=${pedidoId}`;
        console.log('Fetching data from API URL:', apiUrl);

        // Chama a API para obter os dados do pedido
        const [response, planilhasResponse] = await Promise.all([fetch(apiUrl), fetch(planilhasApiUrl)]);
        const pedidos = await response.json();
        const planilha = await planilhasResponse.json();
        console.log('API Response Data:', pedidos);
        console.log('Planilhas API Response Data:', planilha);

        if (!response.ok || !pedidos || pedidos.length === 0) {
          throw new Error(`Erro ao buscar os detalhes do pedido. Status: ${response.status}`);
        }

        if (!planilhasResponse.ok || !planilha || planilha.length === 0) {
          throw new Error(`Erro ao buscar os detalhes da planilha. Status: ${planilhasResponse.status}`);
        }

        // Assume-se que há apenas um pedido e uma planilha a serem exibidos
        const pedido = pedidos[0];
        const dadosPlanilha = planilha[0];

        // Atualiza o ID do pedido na página
        document.getElementById('pedido-id').textContent = pedidoId;

        // Preenche as informações do pedido
        document.getElementById('order-info').innerHTML = `
          <tr>
            <td><select>
              <option value="Pagamento recebido" ${pedido.status === "Pagamento recebido" ? "selected" : ""}>Pagamento recebido</option>
              <option value="Envio de contrato" ${pedido.status === "Envio de contrato" ? "selected" : ""}>Envio de contrato</option>
              <option value="Aguardando Emissão" ${pedido.status === "Aguardando Emissão" ? "selected" : ""}>Aguardando Emissão</option>
              <option value="Pendente de Pagamento" ${pedido.status === "Pendente de Pagamento" ? "selected" : ""}>Pendente de Pagamento</option>
              <option value="Envio de Brindes" ${pedido.status === "Envio de Brindes" ? "selected" : ""}>Envio de Brindes</option>
              <option value="Concluído" ${pedido.status === "Concluído" ? "selected" : ""}>Concluído</option>
            </select></td>
            <td>${pedido.destino || 'N/A'}</td>
            <td>${pedido.item || 'N/A'}</td>
            <td>${formatDate(pedido.data_venda)}</td>
          </tr>`;

        // Preenche as informações do cliente
        document.getElementById('customer-info').innerHTML = `
          <tr>
            <td>${pedido.nome_comprador || 'N/A'}</td>
            <td>${pedido.email || 'N/A'}</td>
            <td>${pedido.telefone || 'N/A'}</td>
            <td>${pedido.cpf || 'N/A'}</td>
            <td>${formatDate(pedido.data_nascimento)}</td>
            <td>${pedido.uf || 'N/A'}</td>
          </tr>`;

        // Preenche as informações financeiras (primeira linha)
        document.getElementById('financial-info').innerHTML = `
          <tr>
            <td>${pedido.gateway || '<input type="text" placeholder="Gateway">'}</td>
            <td>${formatDate(pedido.data_pgto) || '<input type="date">'}</td>
            <td>${pedido.recebido ? `R$ ${parseFloat(pedido.recebido).toFixed(2)}` : '<input type="number" placeholder="Recebido">'}</td>
            <td>${pedido.valor_repassado ? `R$ ${parseFloat(pedido.valor_repassado).toFixed(2)}` : '<input type="number" placeholder="Valor Repassado">'}</td>
            <td>${formatDate(pedido.data_repasse) || '<input type="date">'}</td>
            <td>${pedido.cambio_dia || '<input type="number" placeholder="Cambio do Dia">'}</td>
          </tr>`;

        // Preenche as informações financeiras (segunda linha)
        document.getElementById('financial-info-2').innerHTML = `
          <tr>
            <td>${pedido.valor_comissao ? `R$ ${parseFloat(pedido.valor_comissao).toFixed(2)}` : '<input type="number" placeholder="Valor Comissão">'}</td>
            <td>${pedido.meio_pgto || '<input type="text" placeholder="Meio Pgto">'}</td>
            <td>${pedido.bandeira_cartao || '<input type="text" placeholder="Bandeira Cartão">'}</td>
            <td>${pedido.parcelas || '<input type="number" placeholder="Parcelas">'}</td>
            <td>${pedido.valor_venda ? `R$ ${parseFloat(pedido.valor_venda).toFixed(2)}` : '<input type="number" placeholder="Valor Venda">'}</td>
            <td>${pedido.custo ? `R$ ${parseFloat(pedido.custo).toFixed(2)}` : '<input type="number" placeholder="Custo">'}</td>
            <td>${pedido.fornecedor || '<input type="text" placeholder="Fornecedor">'}</td>
          </tr>`;

        // Preenche as informações comerciais
        document.getElementById('commercial-info').innerHTML = `
          <tr>
            <td>${pedido.origem_cliente || '<input type="text" placeholder="Origem do Cliente">'}</td>
            <td>${pedido.cliente_de || '<input type="text" placeholder="Cliente de (30%)">'}</td>
            <td>${pedido.efetivado_por || '<input type="text" placeholder="Efetivado por (70%)">'}</td>
            <td>${pedido.comissao_do_agente || '<input type="text" placeholder="Comissão Agente">'}</td>
          </tr>`;

        // Preenche as informações adicionais
        document.getElementById('additional-info').innerHTML = `
          <tr>
            <td>${pedido.observacoes_operacionais || '<input type="text" placeholder="Observações Operacionais">'}</td>
            <td>${pedido.observacoes_financeiras || '<input type="text" placeholder="Observações Financeiras">'}</td>
          </tr>`;

        // Preenche a planilha do pedido (primeira linha)
        const dolarCambio = dadosPlanilha.dolar_cambio || '<input type="number" placeholder="Dolar Câmbio">';
        const dolarMagic = dadosPlanilha.dolar_cambio ? (parseFloat(dadosPlanilha.dolar_cambio.replace(",", ".")) * 1.0098).toFixed(2) : '<input type="number" placeholder="Dolar Magic">';
        document.getElementById('spreadsheet-info-1').innerHTML = `
          <tr>
            <td>${dolarCambio}</td>
            <td>${dolarMagic}</td>
          </tr>`;

        // Função para calcular os valores da planilha
        function calcularValores() {
          const netDollar = parseFloat(document.querySelector('#spreadsheet-info-2 input[name="netDollar"]').value) || 0;
          const intermediario = parseFloat(document.querySelector('#spreadsheet-info-2 input[name="intermediario"]').value) || 0;
          const quantidade = parseInt(document.querySelector('#spreadsheet-info-2 input[name="quantidade"]').value) || 0;
          const dolarMagic = parseFloat(document.querySelector('#spreadsheet-info-1 td:nth-child(2)').textContent) || 0;
          const margem = parseFloat(document.querySelector('#spreadsheet-info-2 input[name="margem"]').value) / 100 || 0;
          const gateway = parseFloat(document.querySelector('#spreadsheet-info-2 input[name="gateway"]').value) / 100 || 0;

          const totalDollar = (netDollar + intermediario) * quantidade;
          const netReal = totalDollar * dolarMagic;
          const totalPix = netReal / (1 - margem);
          const total10x = totalPix / (1 - gateway);

          document.querySelector('#spreadsheet-info-2 input[name="totalDollar"]').value = totalDollar.toFixed(2);
          document.querySelector('#spreadsheet-info-2 input[name="netReal"]').value = netReal.toFixed(2);
          document.querySelector('#spreadsheet-info-2 input[name="totalPix"]').value = totalPix.toFixed(2);
          document.querySelector('#spreadsheet-info-2 input[name="total10x"]').value = total10x.toFixed(2);
        }

        // Preenche a planilha do pedido (segunda linha)
        document.getElementById('spreadsheet-info-2').innerHTML = `
          <tr>
            <td>${dadosPlanilha.produto || '<input type="text" placeholder="Produto">'}</td>
            <td>${dadosPlanilha.idade || '<select name="idade"><option value="ADT">ADT</option><option value="CHD">CHD</option></select>'}</td>
            <td>${dadosPlanilha.intermediario || '<input type="number" placeholder="Intermediario" name="intermediario">'}</td>
            <td>${dadosPlanilha.net_dollar || '<input type="number" placeholder="Net U$" name="netDollar">'}</td>
            <td>${dadosPlanilha.quantidade || '<input type="number" placeholder="Quantidade" name="quantidade">'}</td>
            <td><input type="number" placeholder="Total U$" name="totalDollar" readonly></td>
            <td><input type="number" placeholder="Net R$" name="netReal" readonly></td>
            <td>${dadosPlanilha.margem || '<input type="number" placeholder="Margem" name="margem">'}</td>
            <td><input type="number" placeholder="Pix" name="totalPix" readonly></td>
            <td>${dadosPlanilha.gateway || '<input type="number" placeholder="Taxa" name="gateway">'}</td>
            <td><input type="number" placeholder="10x" name="total10x" readonly></td>
          </tr>`;

        // Adiciona evento ao botão para incluir nova linha
        document.getElementById('add-row-button').addEventListener('click', addNewRow);

        // Adiciona eventos para recalcular os valores ao alterar os campos relevantes
        document.querySelectorAll('#spreadsheet-info-2 input, #spreadsheet-info-2 select').forEach(element => {
          element.addEventListener('change', calcularValores);
        });

        // Função para adicionar uma nova linha na planilha do pedido
        function addNewRow() {
          const newRow = `
          <tr>
            <td><input type="text" placeholder="Produto"></td>
            <td>
              <select name="idade">
                <option value="ADT">ADT</option>
                <option value="CHD">CHD</option>
              </select>
            </td>
            <td><input type="number" placeholder="Intermediario" name="intermediario"></td>
            <td><input type="number" placeholder="Net U$" name="netDollar"></td>
            <td><input type="number" placeholder="Quantidade" name="quantidade"></td>
            <td><input type="number" placeholder="Total U$" name="totalDollar" readonly></td>
            <td><input type="number" placeholder="Net R$" name="netReal" readonly></td>
            <td><input type="number" placeholder="Margem" name="margem"></td>
            <td><input type="number" placeholder="Pix" name="totalPix" readonly></td>
            <td><input type="number" placeholder="Taxa" name="gateway"></td>
            <td><input type="number" placeholder="10x" name="total10x" readonly></td>
          </tr>`;
          document.getElementById('spreadsheet-info-2').insertAdjacentHTML('beforeend', newRow);

          // Adiciona eventos para recalcular os valores na nova linha
          document.querySelectorAll('#spreadsheet-info-2 input, #spreadsheet-info-2 select').forEach(element => {
            element.addEventListener('change', calcularValores);
          });
        }

      } catch (error) {
        console.error('Erro ao carregar os detalhes do pedido:', error);
        alert(`Erro ao carregar os dados do pedido: ${error.message}`);
      }
    }

    // Inicializa o carregamento da página
    document.addEventListener('DOMContentLoaded', () => {
      loadSidebar();
      loadOrderDetails();
    });
  </script>
</body>
</html>
