<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Voucher PDF - Edição</title>
  <style>
    /* RESET BÁSICO */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    /* CONTAINER PRINCIPAL (LARGO, CENTRALIZADO) */
    .main-container {
      max-width: 1200px; /* layout amplo */
      margin: 0 auto;
      padding: 20px;
    }

    /* TÍTULO GERAL DA PÁGINA */
    .page-title {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
      color: #444;
    }

    /* =========================================
       SEÇÃO: FORMULÁRIO DE VOUCHER
       ========================================= */
    .voucher-section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .voucher-section h2 {
      font-size: 20px;
      margin-bottom: 15px;
      text-align: center;
      color: #333;
    }
    .voucher-form-group {
      margin-bottom: 20px;
    }
    .voucher-form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #555;
    }
    .voucher-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ÁREA DE UPLOAD MINIMALISTA */
    #dropArea {
      border: 2px dashed #ccc;
      border-radius: 6px;
      padding: 30px;
      text-align: center;
      transition: border-color 0.3s;
      cursor: pointer;
      margin-top: 5px;
    }
    #dropArea:hover {
      border-color: #999;
    }
    #dropArea p {
      margin: 8px 0;
      color: #666;
    }
    #pdfFileInput {
      display: none; /* Oculto, pois usamos a div clicável */
    }
    .convert-button {
      display: inline-block;
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .convert-button:hover {
      background-color: #0056b3;
    }

    /* =========================================
       SEÇÃO: ÚLTIMOS VOUCHERS (TABELA)
       ========================================= */
    .recent-changes-section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .recent-changes-section h3 {
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
      color: #333;
    }
    .changes-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .changes-table thead tr {
      background-color: #007bff;
      color: #fff;
    }
    .changes-table th, .changes-table td {
      text-align: left;
      padding: 8px;
      border: 1px solid #ddd;
    }
    .changes-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .download-link {
      color: #007bff;
      font-weight: bold;
      text-decoration: none;
    }
    .download-link:hover {
      text-decoration: underline;
    }
    /* Controles de Paginação */
    .pagination-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }
    .pagination-controls button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      margin: 0 5px;
      cursor: pointer;
      border-radius: 3px;
      transition: background-color 0.3s;
    }
    .pagination-controls button:hover {
      background-color: #0056b3;
    }
    .pagination-info {
      margin: 0 10px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- TÍTULO DA PÁGINA -->
  <h1 class="page-title">Voucher PDF - Edição</h1>

  <!-- SEÇÃO DE EDIÇÃO DE VOUCHER -->
  <div class="voucher-section">
    <h2>Editar PDF</h2>
    <form id="voucherForm">
      <div class="voucher-form-group">
        <label for="voucherType">Selecione o tipo de voucher:</label>
        <select id="voucherType" name="voucherType" class="voucher-select" required>
          <option value="">-- Selecione --</option>
          <option value="Disney">Disney</option>
          <option value="Universal">Universal</option>
          <option value="SeaWorld">SeaWorld</option>
          <option value="Hospedagem">Hospedagem</option>
        </select>
      </div>

      <!-- Área de Upload estilo "Arraste e Solte" -->
      <div id="dropArea">
        <p>Arraste e solte um arquivo PDF</p>
        <p>ou clique aqui para selecionar do seu computador</p>
        <input type="file" id="pdfFileInput" accept="application/pdf" required />
      </div>

      <br>
      <button type="button" id="convertButton" class="convert-button">Converter e Salvar</button>
    </form>
  </div>

  <!-- SEÇÃO: LISTA DE ÚLTIMOS VOUCHERS -->
  <div class="recent-changes-section" id="recentChangesContainer">
    <h3>Últimos Vouchers</h3>
    <table class="changes-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data/Hora</th>
          <th>Categoria</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody id="recentChangesBody">
        <!-- Itens com paginação -->
      </tbody>
    </table>
    <div class="pagination-controls">
      <button id="prevPageBtn">&laquo; Anterior</button>
      <div id="paginationInfo" class="pagination-info"></div>
      <button id="nextPageBtn">Próxima &raquo;</button>
    </div>
  </div>
</div>

<!-- Biblioteca PDF-lib -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
/*  
   =======================================
   CONFIGURAÇÕES DE VOUCHER (INSERÇÃO DE IMAGENS)
   =======================================
*/
const disneyVoucherConfig = {
  images: [
    {
      url: "https://business.magictraveltur.com/image/Logofundo.png",
      left: 66,
      top: 47,
      width: 171,
      height: 47,
      pages: "0"
    },
    {
      url: "https://business.magictraveltur.com/image/Tarja.png",
      left: 178,
      top: 31,
      width: 350,
      height: 26,
      pages: "0"
    }
  ]
};

const universalVoucherConfig = {
  images: [
    {
      url: "https://business.magictraveltur.com/image/Logofundo.png",
      left: 352,
      top: 47,
      width: 196,
      height: 44,
      pages: "all"
    },
    {
      url: "https://business.magictraveltur.com/image/Tarja.png",
      left: 15.92,
      top: 504.22,
      width: 571.74,
      height: 160.32,
      pages: "all"
    }
  ]
};

const seaWorldVoucherConfig = {
  images: [
    {
      url: "https://business.magictraveltur.com/image/Tarja.png",
      left: 225,
      top: 644,
      width: 146,
      height: 16,
      pages: "all"
    },
    {
      url: "https://business.magictraveltur.com/image/Logofundo.png",
      left: 447,
      top: 51,
      width: 83,
      height: 23,
      pages: "all"
    }
  ]
};

/*  
   =======================================
   ENDPOINTS (AJUSTE PARA SEUS SCRIPTS)
   =======================================
*/
const UPLOAD_URL = "https://magictraveltur.com/upload_voucher.php";
const LIST_URL   = "https://magictraveltur.com/list_vouchers.php"; // retorna JSON

/*  
   =======================================
   DOM: FORMULÁRIO E ÁREA DE UPLOAD
   =======================================
*/
const voucherTypeSelect = document.getElementById("voucherType");
const pdfFileInput      = document.getElementById("pdfFileInput");
const convertButton     = document.getElementById("convertButton");

// Arraste e Solte
const dropArea = document.getElementById('dropArea');
dropArea.addEventListener('click', () => {
  pdfFileInput.click();
});
dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.style.borderColor = '#007bff';
});
dropArea.addEventListener('dragleave', () => {
  dropArea.style.borderColor = '#ccc';
});
dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.style.borderColor = '#ccc';
  if (e.dataTransfer.files.length) {
    const file = e.dataTransfer.files[0];
    if (file.type === "application/pdf") {
      pdfFileInput.files = e.dataTransfer.files;
    } else {
      alert("Por favor, solte apenas arquivos PDF.");
    }
  }
});

/*  
   =======================================
   LOGICA PDF (pdf-lib)
   =======================================
*/
function fileToArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = e => reject(e);
    r.readAsArrayBuffer(file);
  });
}
async function fetchImageAsBytes(url) {
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("Erro ao buscar imagem: " + url);
  return await resp.arrayBuffer();
}
async function mergePDFWithConfig(originalPdfBytes, config) {
  const pdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
  const totalPages = pdfDoc.getPageCount();

  for (const img of config.images) {
    const imgBytes = await fetchImageAsBytes(img.url);
    let embeddedImg;
    try {
      embeddedImg = await pdfDoc.embedPng(imgBytes);
    } catch {
      embeddedImg = await pdfDoc.embedJpg(imgBytes);
    }
    if (img.pages === "all") {
      // Adiciona a TODAS as páginas
      for (let i = 0; i < totalPages; i++) {
        const page = pdfDoc.getPage(i);
        const { height: pageHeight } = page.getSize();
        const x = img.left ?? 0;
        const y = pageHeight - (img.top ?? 0) - (img.height ?? embeddedImg.height);
        page.drawImage(embeddedImg, {
          x, y,
          width:  img.width  ?? embeddedImg.width,
          height: img.height ?? embeddedImg.height
        });
      }
    } else {
      // Adiciona apenas na página específica (ex: "0")
      const pageIndex = parseInt(img.pages, 10) || 0;
      if (pageIndex >= 0 && pageIndex < totalPages) {
        const page = pdfDoc.getPage(pageIndex);
        const { height: pageHeight } = page.getSize();
        const x = img.left ?? 0;
        const y = pageHeight - (img.top ?? 0) - (img.height ?? embeddedImg.height);
        page.drawImage(embeddedImg, {
          x, y,
          width:  img.width  ?? embeddedImg.width,
          height: img.height ?? embeddedImg.height
        });
      }
    }
  }
  return pdfDoc.save();
}
async function uploadFinalPDF(pdfBytes, category) {
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const formData = new FormData();
  formData.append("pdfFile", blob, "VoucherEditado.pdf");
  formData.append("voucherType", category);

  const resp = await fetch(UPLOAD_URL, { method: "POST", body: formData });
  if (!resp.ok) {
    const errData = await resp.json().catch(()=>({}));
    throw new Error(errData.error || "Falha no upload_voucher.php");
  }
  const result = await resp.json();
  if (!result.success) throw new Error(result.error || "Falha ao salvar PDF");
  return result;
}

/*  
   =======================================
   BOTÃO "CONVERTER" => PROCESSA E SOBE PDF
   =======================================
*/
convertButton.addEventListener('click', async () => {
  const category = voucherTypeSelect.value;
  const file     = pdfFileInput.files[0];
  if (!category) {
    alert("Selecione uma categoria de voucher!");
    return;
  }
  if (!file) {
    alert("Selecione ou arraste um arquivo PDF!");
    return;
  }
  try {
    // Carrega bytes do PDF original
    const originalPdfBytes = await fileToArrayBuffer(file);

    // Seleciona a config de imagens
    let config;
    if (category === "Disney") {
      config = disneyVoucherConfig;
    } else if (category === "Universal") {
      config = universalVoucherConfig;
    } else if (category === "SeaWorld") {
      config = seaWorldVoucherConfig;
    } else {
      // Hospedagem => sem inserir imagens
      config = { images: [] };
    }

    // Mescla imagens no PDF (pdf-lib)
    const finalPdfBytes = await mergePDFWithConfig(originalPdfBytes, config);

    // Upload do PDF final para o servidor
    await uploadFinalPDF(finalPdfBytes, category);

    alert("PDF salvo com sucesso! Voucher: " + category);

    // Recarrega lista de vouchers
    loadRecentChanges();
  } catch (err) {
    console.error(err);
    alert("Erro: " + err.message);
  }
});

/*  
   =======================================
   LISTA DE ÚLTIMOS VOUCHERS (PAGINADA)
   =======================================
*/
let allRecords   = [];
let currentPage  = 1;
const pageSize   = 10;

const recentChangesBody = document.getElementById('recentChangesBody');
const prevPageBtn       = document.getElementById('prevPageBtn');
const nextPageBtn       = document.getElementById('nextPageBtn');
const paginationInfo    = document.getElementById('paginationInfo');

async function loadRecentChanges() {
  try {
    const resp = await fetch(LIST_URL);
    if (!resp.ok) throw new Error("Falha ao listar vouchers");
    const data = await resp.json();
    allRecords  = data;
    currentPage = 1;
    renderCurrentPage();
  } catch (error) {
    console.error("Erro loadRecentChanges:", error);
  }
}

function renderCurrentPage() {
  recentChangesBody.innerHTML = "";
  const totalPages = Math.ceil(allRecords.length / pageSize);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  const startIndex = (currentPage - 1) * pageSize;
  const endIndex   = startIndex + pageSize;
  const pageItems  = allRecords.slice(startIndex, endIndex);

  pageItems.forEach(item => {
    const row = document.createElement('tr');

    const idTd       = document.createElement('td');
    const dateTd     = document.createElement('td');
    const categoryTd = document.createElement('td');
    const downloadTd = document.createElement('td');

    idTd.textContent       = item.id;
    dateTd.textContent     = item.created_at;  // Exemplo: "2025-02-21 14:35"
    categoryTd.textContent = item.category;

    // Link para download
    const link = document.createElement('a');
    link.href        = item.downloadURL;
    link.textContent = "Download";
    link.classList.add('download-link');
    link.target      = "_blank";
    link.setAttribute('download', "VoucherEditado.pdf");
    downloadTd.appendChild(link);

    row.appendChild(idTd);
    row.appendChild(dateTd);
    row.appendChild(categoryTd);
    row.appendChild(downloadTd);
    recentChangesBody.appendChild(row);
  });

  paginationInfo.textContent = `Página ${currentPage} de ${totalPages || 1}`;
  prevPageBtn.disabled = (currentPage <= 1);
  nextPageBtn.disabled = (currentPage >= totalPages);
}

prevPageBtn.addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    renderCurrentPage();
  }
});
nextPageBtn.addEventListener('click', () => {
  const totalPages = Math.ceil(allRecords.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    renderCurrentPage();
  }
});

/*  
   =======================================
   AO CARREGAR A PÁGINA
   =======================================
*/
window.addEventListener('DOMContentLoaded', () => {
  loadRecentChanges();
});
</script>
</body>
</html>
