<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sobrepor Todas as Páginas (Front-End) - com Sidebar</title>
  <style>
    /* =============================
       Layout geral com sidebar
       ============================= */
    #voucher-page-container {
      display: flex;
      flex-direction: row;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    #sidebar-container {
      width: 250px;
      border-right: 1px solid #ccc;
    }
    #sidebar-frame {
      width: 100%;
      height: 100vh;
      border: none;
    }

    /* ============================
       Conteúdo principal
       ============================ */
    #main-content {
      flex: 1;
      padding: 20px;
    }

    /* ============================
       Container do formulário
       ============================ */
    .overlay-form-container {
      max-width: 600px;
      margin: 0 auto;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 5px;
    }

    .overlay-form-container h2 {
      text-align: center;
      margin-top: 0;
    }

    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .form-group input[type="file"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    #mergeButton {
      display: inline-block;
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 16px;
    }
    #mergeButton:hover {
      background-color: #0056b3;
    }

    /* Link de download */
    #downloadLink {
      display: inline-block;
      margin-top: 15px;
      font-weight: bold;
      text-decoration: none;
      color: #007bff;
    }
    #downloadLink:hover {
      text-decoration: underline;
    }

    /* Mensagem de erro/sucesso */
    #resultMessage {
      margin-top: 15px;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body>
  <div id="voucher-page-container">
    <!-- SIDEBAR -->
    <div id="sidebar-container">
      <iframe src="sidebar.html" id="sidebar-frame"></iframe>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div id="main-content">
      <div class="overlay-form-container">
        <h2>Sobrepor PDFs (todas as páginas)</h2>

        <div class="form-group">
          <label for="basePdfFile">PDF Base:</label>
          <input type="file" id="basePdfFile" accept="application/pdf" />
        </div>

        <div class="form-group">
          <label for="overlayPdfFile">PDF Overlay:</label>
          <input type="file" id="overlayPdfFile" accept="application/pdf" />
        </div>

        <button id="mergeButton">Mesclar (Todas as Páginas)</button>
        <a id="downloadLink" href="#" download="PdfSobreposto_TodasPaginas.pdf" style="display:none;">
          Baixar PDF Final
        </a>

        <div id="resultMessage"></div>
      </div>
    </div>
  </div>

  <!-- PDF-Lib (CDN) -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

  <script>
    /*
      =============================================================================
      Exemplo que sobrepõe TODAS as páginas do PDF Overlay em TODAS as páginas
      correspondentes do PDF Base (índice a índice), via PDF-Lib no Front-End.
      Inclui sidebar.html via iframe, conforme seu padrão anterior.
      =============================================================================
    */

    // Referências
    const basePdfFileInput    = document.getElementById('basePdfFile');
    const overlayPdfFileInput = document.getElementById('overlayPdfFile');
    const mergeButton         = document.getElementById('mergeButton');
    const downloadLink        = document.getElementById('downloadLink');
    const resultMessage       = document.getElementById('resultMessage');

    // Helper: Ler File -> ArrayBuffer
    function fileToArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = err => reject(err);
        reader.readAsArrayBuffer(file);
      });
    }

    // Exibir erro
    function showError(msg) {
      resultMessage.textContent = msg;
      resultMessage.style.display = "block";
      resultMessage.style.color = "red";
    }

    // Clique no botão "Mesclar"
    mergeButton.addEventListener('click', async () => {
      // Esconde mensagens e link antes de iniciar
      resultMessage.style.display = "none";
      downloadLink.style.display = "none";

      // Obter arquivos
      const baseFile = basePdfFileInput.files[0];
      const overlayFile = overlayPdfFileInput.files[0];

      if (!baseFile || !overlayFile) {
        showError("Selecione o PDF Base e o PDF Overlay.");
        return;
      }

      try {
        // Ler bytes de ambos os arquivos
        const basePdfBytes = await fileToArrayBuffer(baseFile);
        const overlayPdfBytes = await fileToArrayBuffer(overlayFile);

        // Carrega no PDF-Lib
        const basePdfDoc = await PDFLib.PDFDocument.load(basePdfBytes);
        const overlayPdfDoc = await PDFLib.PDFDocument.load(overlayPdfBytes);

        const basePageCount    = basePdfDoc.getPageCount();
        const overlayPageCount = overlayPdfDoc.getPageCount();

        // Determina até onde vamos sobrepor
        const pagesToOverlay = Math.min(basePageCount, overlayPageCount);

        // Copiamos as páginas do overlay de uma só vez
        // Exemplo: se pagesToOverlay=5, copia [0,1,2,3,4]
        const overlayPages = await basePdfDoc.copyPages(
          overlayPdfDoc,
          Array.from({ length: pagesToOverlay }, (_, i) => i)
        );

        // Agora, para cada página i, desenha overlayPages[i] em basePages[i]
        for (let i = 0; i < pagesToOverlay; i++) {
          const basePage = basePdfDoc.getPage(i);
          const overlayPage = overlayPages[i];

          // Tamanho da página base
          const { width: baseWidth, height: baseHeight } = basePage.getSize();
          // Tamanho da página overlay
          const { width: overlayWidth, height: overlayHeight } = overlayPage.getSize();

          // Escala para caber
          const scale = Math.min(baseWidth / overlayWidth, baseHeight / overlayHeight);

          const newWidth  = overlayWidth * scale;
          const newHeight = overlayHeight * scale;

          // Desenha a página overlay no canto inferior
          basePage.drawPage(overlayPage, {
            x: 0,
            y: 0,
            width: newWidth,
            height: newHeight
          });
        }

        // Salva o PDF resultante
        const mergedPdfBytes = await basePdfDoc.save();

        // Cria Blob e link de download
        const mergedBlob = new Blob([mergedPdfBytes], { type: "application/pdf" });
        const blobUrl = URL.createObjectURL(mergedBlob);

        downloadLink.href = blobUrl;
        downloadLink.style.display = "inline-block";

      } catch (error) {
        console.error(error);
        showError("Erro ao mesclar PDFs: " + error.message);
      }
    });
  </script>
</body>
</html>
