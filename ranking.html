<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Estilo Apple - Date Range + GrÃ¡fico Filtrado</title>

  <!-- Chart.js (grÃ¡ficos) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    :root {
      /* Paleta inspirada em tons suaves e minimalistas */
      --bg-page: #EFF0F3;       /* fundo global */
      --bg-white: #FFFFFF;      /* cartÃµes */
      --bg-dark: #1C1C1C;
      --primary-color: #0071E3; /* azul estilo Apple */
      --text-color: #333333;
      --text-muted: #777777;
      --radius: 12px;           /* cantos ainda mais arredondados */
      --shadow: 0 8px 20px rgba(0,0,0,0.08); /* sombra sutil e maior */
    }
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }
    body {
      background-color: var(--bg-page);
      color: var(--text-color);
      min-height: 100vh;
    }
    /* Layout principal: Sidebar + ConteÃºdo */
    .dashboard {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 260px;
      min-width: 260px;
      background: var(--bg-white);
      box-shadow: var(--shadow);
    }
    .main-content {
      flex: 1;
      padding: 30px;
    }
    .dashboard-container {
      max-width: 1300px;
      margin: 0 auto;
    }

    /*********************************************************
     * CabeÃ§alho minimalista
     *********************************************************/
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .dashboard-header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #000;
    }

    /* Filtros (data range + finalizadoPor + botÃ£o Filtrar) */
    .filters {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .date-range-wrapper {
      display: flex;
      align-items: center;
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 4px 10px;
    }
    .date-range-wrapper input[type="date"] {
      background: transparent;
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--text-color);
      padding: 5px;
      width: 120px;
    }
    .date-range-wrapper span.separator {
      font-size: 14px;
      color: #999;
      margin: 0 5px;
    }
    .filters select {
      padding: 6px 12px;
      border: none;
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      outline: none;
      font-size: 14px;
      color: #666;
    }
    .filters button {
      background: var(--primary-color);
      color: #FFF;
      border: none;
      border-radius: var(--radius);
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: background 0.2s ease;
    }
    .filters button:hover {
      background: #005BB5; /* escurece um pouco */
    }

    /*********************************************************
     * Linha superior: 4 cartÃµes + box preto
     *********************************************************/
    .top-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background-color: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: transform 0.2s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
    }
    .stat-icon {
      font-size: 32px;
      margin-bottom: 10px;
      color: #666;
    }
    .stat-info h2 {
      font-size: 24px;
      margin-bottom: 5px;
      color: #000;
    }
    .stat-info p {
      font-size: 15px;
      color: var(--text-muted);
    }
    .dark-box {
      background-color: #000;
      color: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: transform 0.2s ease;
    }
    .dark-box:hover {
      transform: translateY(-2px);
    }

    /*********************************************************
     * GrÃ¡fico de Barras
     *********************************************************/
    .bar-chart-container {
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 30px;
    }
    .bar-chart-container h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #000;
    }
    .bar-chart-container canvas {
      width: 100% !important;
      height: 320px !important;
    }

    /*********************************************************
     * Linha inferior: Pedidos + Monthly Billing
     *********************************************************/
    .bottom-row {
      display: flex;
      gap: 20px;
    }

    /* Pedidos (tabela) */
    .pedidos-section {
      flex: 3;
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .pedidos-section h3 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #000;
    }
    .pedidos-section table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    .pedidos-section thead {
      background: #f0f0f0;
    }
    .pedidos-section thead th {
      text-align: left;
      padding: 8px;
      font-size: 14px;
      color: var(--text-muted);
    }
    .pedidos-section tbody tr {
      border-bottom: 1px solid #eee;
    }
    .pedidos-section tbody tr:last-child {
      border-bottom: none;
    }
    .pedidos-section tbody td {
      padding: 8px;
      font-size: 14px;
    }
    /* PaginaÃ§Ã£o */
    .pagination {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: center;
      justify-content: flex-end;
    }
    .pagination button {
      background: var(--primary-color);
      border: none;
      color: #FFF;
      border-radius: var(--radius);
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .pagination span {
      font-size: 14px;
      color: #666;
    }

    /* Monthly billing (half donut) */
    .billing-section {
      flex: 2;
      background: var(--bg-white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .billing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }
    .billing-header h4 {
      font-size: 18px;
      font-weight: 600;
      color: #000;
      margin: 0;
    }
    .tabs {
      display: flex;
      gap: 20px;
    }
    .tabs span {
      font-size: 15px;
      color: #777;
      cursor: pointer;
      padding-bottom: 5px;
    }
    .tabs span.active {
      color: #000;
      border-bottom: 2px solid var(--primary-color);
    }
    .donut-container {
      position: relative;
      width: 100%;
      height: 220px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex: 1;
    }
    #billingChart {
      max-width: 200px;
      height: 200px !important;
    }
    .donut-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    .donut-center-text .total-label {
      font-size: 13px;
      color: #999;
    }
    .donut-center-text .total-value {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin-top: 2px;
    }
    .donut-legend {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .donut-legend div {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
  </style>
</head>

<body>
<div class="dashboard">
  <!-- SIDEBAR (carregado via fetch) -->
  <div class="sidebar" id="sidebar"></div>

  <div class="main-content">
    <div class="dashboard-container">

      <!-- CabeÃ§alho -->
      <header class="dashboard-header">
        <h1>Dashboard</h1>
        <!-- Filtros: Data (unidos) + efetivadoPor + Filtrar -->
        <div class="filters">
          <!-- Date Range wrapper => single â€œbotÃ£oâ€ -->
          <div class="date-range-wrapper">
            <input type="date" id="dataInicial" />
            <span class="separator">â€“</span>
            <input type="date" id="dataFinal" />
          </div>
          <select id="efetivadoPorSelect"></select>
          <button id="btnFiltrar">Filtrar</button>
        </div>
      </header>

      <!-- Linha superior: 5 colunas -->
      <div class="top-row">
        <!-- ComissÃ£o -->
        <div class="stat-card">
          <div class="stat-icon">ðŸ’¸</div>
          <div class="stat-info">
            <h2 id="cardComissao">R$ 0</h2>
            <p>ComissÃ£o</p>
          </div>
        </div>
        <!-- Margem -->
        <div class="stat-card">
          <div class="stat-icon">ðŸ“ˆ</div>
          <div class="stat-info">
            <h2 id="cardMargem">0%</h2>
            <p>Margem</p>
          </div>
        </div>
        <!-- Faturamento -->
        <div class="stat-card">
          <div class="stat-icon">ðŸ’°</div>
          <div class="stat-info">
            <h2 id="cardFaturamento">R$ 0</h2>
            <p>Faturamento</p>
          </div>
        </div>
        <!-- Take Rate -->
        <div class="stat-card">
          <div class="stat-icon">ðŸ”—</div>
          <div class="stat-info">
            <h2 id="cardTakeRate">0%</h2>
            <p>Take Rate</p>
          </div>
        </div>
        <!-- Box preto -->
        <div class="dark-box">
          <h4>Categoria de Vendedor</h4>
          <p id="vendedorCategoria">Vendedor Bronze</p>
          <span>Exemplo de texto</span>
        </div>
      </div>

      <!-- GrÃ¡fico de barras: Faturamento x Margem -->
      <section class="bar-chart-container">
        <h3>Faturamento x Margem</h3>
        <canvas id="faturamentoMargemChart"></canvas>
      </section>

      <!-- Linha inferior: Pedidos + Monthly billing -->
      <div class="bottom-row">
        <!-- Pedidos (paginado) -->
        <div class="pedidos-section">
          <h3>Pedidos</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Data da Venda</th>
                <th>Cliente</th>
                <th>Valor</th>
                <th>Pagamento</th>
                <th>ComissÃ£o</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tableBodyPedidos">
              <!-- Linhas, 5 p/ pÃ¡gina -->
            </tbody>
          </table>
          <!-- PaginaÃ§Ã£o -->
          <div class="pagination">
            <button id="btnAnterior">Anterior</button>
            <span id="paginationInfo">PÃ¡gina 1 de 1</span>
            <button id="btnProximo">PrÃ³ximo</button>
          </div>
        </div>

        <!-- Monthly Billing (Half Donut) -->
        <div class="billing-section">
          <div class="billing-header">
            <h4>Monthly billing</h4>
            <div class="tabs">
              <span id="tabFaturamento" class="active">Faturamento</span>
              <span id="tabMargem">Margem</span>
            </div>
          </div>
          <div class="donut-container">
            <canvas id="billingChart"></canvas>
            <div class="donut-center-text">
              <div class="total-label">Percentual</div>
              <div class="total-value" id="billingTotal">0%</div>
            </div>
          </div>
          <div class="donut-legend">
            <div><span class="legend-color" id="legendColor"></span> NÃ­vel</div>
          </div>
        </div>
      </div><!-- /bottom-row -->

    </div><!-- /dashboard-container -->
  </div><!-- /main-content -->
</div><!-- /dashboard -->

<script>
// =============== SIDEBAR ===============
fetch('sidebar.html')
  .then(resp=>resp.text())
  .then(html => {
    document.getElementById('sidebar').innerHTML= html;
  })
  .catch(err=> console.error('Sidebar error:', err));

// VariÃ¡veis globais
let chartFM; 
let currentChartBilling;
let modoBilling='faturamento';

let pedidosGlobal=[];
let currentPage=1;
const pageSize=5;

// Ao carregar, sÃ³ carrega a lista de "efetivado_por"
window.addEventListener('load', async ()=>{
  await carregarListaEfetivadoPor();
});

// BotÃ£o Filtrar => carrega dados
document.getElementById('btnFiltrar').addEventListener('click', ()=>{
  carregarDados();
});

// PaginaÃ§Ã£o
document.getElementById('btnAnterior').addEventListener('click', ()=>{
  if(currentPage>1){
    currentPage--;
    exibirPagina(pedidosGlobal, currentPage);
  }
});
document.getElementById('btnProximo').addEventListener('click', ()=>{
  let totalPages= Math.ceil(pedidosGlobal.length/pageSize);
  if(currentPage<totalPages){
    currentPage++;
    exibirPagina(pedidosGlobal, currentPage);
  }
});

// Aba Faturamento
document.getElementById('tabFaturamento').addEventListener('click',()=>{
  document.getElementById('tabFaturamento').classList.add('active');
  document.getElementById('tabMargem').classList.remove('active');
  modoBilling='faturamento';
  calcularTierEExibirNoBilling();
});
// Aba Margem
document.getElementById('tabMargem').addEventListener('click',()=>{
  document.getElementById('tabMargem').classList.add('active');
  document.getElementById('tabFaturamento').classList.remove('active');
  modoBilling='margem';
  calcularTierEExibirNoBilling();
});

// 1) Carregar lista (distinct efetivado_por)
async function carregarListaEfetivadoPor(){
  let url='https://www.magictraveltur.com/api_pedidos.php?distinct_efetivado_por=1';
  try{
    let resp= await fetch(url);
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    let arr= await resp.json(); // ex.: ["Vanessa Barreto","Matheus Alvarenga",...]
    let sel= document.getElementById('efetivadoPorSelect');
    sel.innerHTML='<option value="">Todos</option>';
    arr.forEach(nome=>{
      let opt=document.createElement('option');
      opt.value=nome;
      opt.textContent=nome;
      sel.appendChild(opt);
    });
  }catch(e){
    console.error('Erro distinct efetivado_por:', e);
  }
}

// 2) Carregar Dados
async function carregarDados(){
  const dataInicial= document.getElementById('dataInicial').value || '';
  const dataFinal= document.getElementById('dataFinal').value || '';
  const efetivadoPor= document.getElementById('efetivadoPorSelect').value || '';

  if(!dataInicial && !dataFinal && !efetivadoPor){
    alert('Selecione ao menos um perÃ­odo ou a pessoa (efetivado_por).');
    return;
  }
  let url= `https://www.magictraveltur.com/api_pedidos.php?start_date=${dataInicial}&end_date=${dataFinal}&efetivado_por=${efetivadoPor}`;
  try{
    let resp= await fetch(url);
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    let dados= await resp.json();
    if(!Array.isArray(dados)){
      console.warn('Resposta nÃ£o Ã© array:', dados);
      return;
    }
    pedidosGlobal=dados;
    currentPage=1;
    exibirPagina(pedidosGlobal, currentPage);
    // Preenche cartÃµes
    somarCartoes(pedidosGlobal);
    // Agrupar p/ grÃ¡fico
    let {arrFat, arrMarg}= agruparPorMes(pedidosGlobal, dataInicial, dataFinal);
    renderGraficoBarras(arrFat, arrMarg, dataInicial, dataFinal);
    // Monthly billing
    calcularTierEExibirNoBilling(arrFat, arrMarg);
  }catch(e){
    console.error('Erro ao carregar:', e);
    alert('Erro ao carregar: '+ e.message);
  }
}

// 3) Exibir pÃ¡gina (5 por vez)
function exibirPagina(pedidos, page){
  currentPage=page;
  let startIndex=(page-1)*pageSize;
  let endIndex= page*pageSize;
  let slice= pedidos.slice(startIndex, endIndex);

  let tbody= document.getElementById('tableBodyPedidos');
  tbody.innerHTML='';
  slice.forEach(p=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`
      <td>#${p.id}</td>
      <td>${p.data_venda||''}</td>
      <td>${p.nome_comprador||''}</td>
      <td>R$ ${(Number(p.valor_venda)||0).toLocaleString('pt-BR')}</td>
      <td>${p.meio_pgto||''}</td>
      <td>R$ ${(Number(p.comissao_do_agente)||0).toLocaleString('pt-BR')}</td>
      <td>${p.status||''}</td>
    `;
    tbody.appendChild(tr);
  });

  // Paginas
  let totalPages= Math.ceil(pedidos.length/pageSize);
  document.getElementById('paginationInfo').textContent=
    `PÃ¡gina ${page} de ${totalPages}`;
}

// 4) Somar cartÃµes
function somarCartoes(pedidos){
  let somaFat=0, somaCom=0, somaMarg=0;
  pedidos.forEach(p=>{
    somaFat += Number(p.valor_venda)||0;
    somaCom += Number(p.comissao_do_agente)||0;
    somaMarg+= Number(p.valor_comissao)||0; // se preferir outro campo, troque
  });
  document.getElementById('cardFaturamento').textContent=
    'R$ '+ somaFat.toLocaleString('pt-BR');
  document.getElementById('cardComissao').textContent=
    'R$ '+ somaCom.toLocaleString('pt-BR');
  // Exibe como R$
  document.getElementById('cardMargem').textContent=
    somaMarg.toLocaleString('pt-BR')+' (R$)';
  // Take Rate
  let take= (somaFat>0)? (somaCom/somaFat)*100 :0;
  document.getElementById('cardTakeRate').textContent= take.toFixed(2)+'%';
  // Categoria
  let cat='Vendedor Bronze';
  if(take>30) cat='Vendedor Diamante';
  document.getElementById('vendedorCategoria').textContent=cat;
}

// 5) Agrupar p/ grÃ¡fico (apenas meses dentro do range)
function agruparPorMes(pedidos, startDate, endDate){
  // Converter start e end p/ YYYY-MM (pegar o range)
  let arrFat=[];
  let arrMarg=[];
  // 1) Cria array de meses no range
  let rangeMeses= gerarListaMesesNoRange(startDate, endDate); 
  // ex.: ["2025-01","2025-02","2025-03"]

  // Inicializa arrFat, arrMarg com zero
  rangeMeses.forEach(()=> {
    arrFat.push(0);
    arrMarg.push(0);
  });

  // 2) Preenche
  pedidos.forEach(p=>{
    let dataVenda= (p.data_venda||'').substring(0,7); // "YYYY-MM"
    // Se "2025-01" estÃ¡ no range, soma
    let idx= rangeMeses.indexOf(dataVenda);
    if(idx>=0){
      arrFat[idx]+= Number(p.valor_venda)||0;
      arrMarg[idx]+= Number(p.valor_comissao)||0;
    }
  });

  return { arrFat, arrMarg, rangeMeses };
}

// Gera array de strings "YYYY-MM" do start ao end
function gerarListaMesesNoRange(startDate, endDate){
  if(!startDate || !endDate) return [];
  // converter p/ Date
  let start= new Date(startDate+'-01'); // arriscamos
  let end= new Date(endDate+'-01');
  // se user escolheu 2025-01-15, arriscamos "2025-01"
  if(isNaN(start.getTime())|| isNaN(end.getTime())) return [];
  if(start> end) [start, end]=[end, start];
  // loop
  let arr=[];
  let current= new Date(start);
  while(current<= end){
    let y= current.getFullYear();
    let m= String(current.getMonth()+1).padStart(2,'0');
    arr.push(`${y}-${m}`);
    // avanÃ§a 1 mes
    current.setMonth(current.getMonth()+1);
  }
  return arr;
}

// 6) Render Grafico
function renderGraficoBarras(arrFat, arrMarg, startDate, endDate){
  if(chartFM) chartFM.destroy();

  // Precisamos do array de labels => ex.: ["2025-01","2025-02",...]
  // mas no agruparPorMes, retornamos "rangeMeses" (ver arrFat.rangeMeses?), ajustamos a funÃ§Ã£o
  if(Array.isArray(arrFat.rangeMeses)){
    // mas nÃ³s mudamos a sign. Precisamos desestruturar?
  }

  // Ajuste -> agruparPorMes retorna {arrFat, arrMarg, rangeMeses}
  // mas chamamos "arrFat, arrMarg= agruparPorMes(...)"
  // Precisamos "rangeMeses= agruparPorMes(...).rangeMeses" => reescrever:
  if(!Array.isArray(arrFat)){
    // se passamos objeto
    arrMarg= arrFat.arrMarg;
    startDate= arrFat.startDate;
    endDate= arrFat.endDate;
    let tmp= arrFat;
    arrFat= tmp.arrFat;
  }

  let canvas= document.getElementById('faturamentoMargemChart').getContext('2d');

  // se a func agruparPorMes retornou "rangeMeses" => passamos como 3o param
  let rangeMeses= arrFat.rangeMeses; // se exist
  if(!rangeMeses){
    // refaz
    let {arrFat: aF, arrMarg: aM, rangeMeses: rM}= agruparPorMes(pedidosGlobal, startDate, endDate);
    arrFat= aF; arrMarg= aM; rangeMeses= rM;
  }
  // Exemplo label: "2025-01" => "Jan/2025"
  let finalLabels= rangeMeses.map(m=>{
    let [yyyy, mm]= m.split('-');
    let dt= new Date(Number(yyyy), Number(mm)-1, 1);
    let mesNome= dt.toLocaleString('pt-BR',{month:'short'}); // "jan", "fev"
    return mesNome+'/'+ yyyy;
  });

  chartFM= new Chart(canvas, {
    type:'bar',
    data:{
      labels: finalLabels,
      datasets:[
        {
          label:'Faturamento (R$)',
          data: arrFat,
          backgroundColor:'#000',
          borderRadius:4,
          barPercentage:0.6
        },
        {
          label:'Margem (R$)',
          data: arrMarg,
          backgroundColor:'#BBB',
          borderRadius:4,
          barPercentage:0.6
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{beginAtZero:true,ticks:{color:'#666'}},
        x:{grid:{display:false},ticks:{color:'#666'}}
      }
    }
  });
}

// 7) Monthly Billing
function calcularTierEExibirNoBilling(arrFat, arrMarg){
  if(!arrFat || !arrMarg || !Array.isArray(arrFat)||!Array.isArray(arrMarg)){
    let {arrFat:af, arrMarg:am}= agruparPorMes(pedidosGlobal, 
      document.getElementById('dataInicial').value, 
      document.getElementById('dataFinal').value
    );
    arrFat= af; arrMarg= am;
  }
  let valor=0;
  if(modoBilling==='faturamento'){
    valor= arrFat.reduce((acc,val)=>acc+val,0);
    calcularTierEExibir(valor,'faturamento');
  } else {
    valor= arrMarg.reduce((acc,val)=>acc+val,0);
    calcularTierEExibir(valor,'margem');
  }
}

function calcularTierEExibir(valor,tipo){
  let tiersFat=[
    {nome:'Bronze',min:0,max:294000,cor:'#CD7F32'},
    {nome:'Prata',min:294000,max:534000,cor:'#C0C0C0'},
    {nome:'Ouro', min:534000,max:768000,cor:'#FFD700'},
    {nome:'Black',min:768000,max:1068000,cor:'#000000'}
  ];
  let tiersMarg=[
    {nome:'Bronze',min:0,max:23670,cor:'#CD7F32'},
    {nome:'Prata',min:23670,max:42120,cor:'#C0C0C0'},
    {nome:'Ouro', min:42120,max:60570,cor:'#FFD700'},
    {nome:'Black',min:60570,max:81570,cor:'#000000'}
  ];
  let tiers= (tipo==='faturamento')? tiersFat : tiersMarg;
  let tierAtual= tiers[0], perc=0;
  for(let i=0;i<tiers.length;i++){
    let t= tiers[i];
    if(valor>=t.min && valor<t.max){
      tierAtual=t;
      perc=((valor-t.min)/(t.max-t.min))*100;
      break;
    } else if(valor>= tiers[tiers.length-1].max){
      tierAtual= tiers[tiers.length-1];
      perc=100;
      break;
    }
  }
  renderBillingChart(perc, tierAtual.cor);
  document.getElementById('billingTotal').textContent= perc.toFixed(1)+'%';
  document.getElementById('legendColor').style.background= tierAtual.cor;
}

function renderBillingChart(perc,cor){
  if(currentChartBilling) currentChartBilling.destroy();
  let ctx= document.getElementById('billingChart').getContext('2d');
  let v1= perc;
  let v2= 100-perc;
  currentChartBilling= new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Tier','Restante'],
      datasets:[{
        data:[v1,v2],
        backgroundColor:[cor,'#EEE'],
        hoverOffset:4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      cutout:'70%',
      rotation:-90,
      circumference:180,
      plugins:{legend:{display:false}},
      animation:{animateRotate:true,animateScale:true,duration:700}
    }
  });
}
</script>
</body>
</html>
